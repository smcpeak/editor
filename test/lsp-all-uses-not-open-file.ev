// lsp-all-uses-not-open-file.ev
// "All uses" where an occurrence is in a file that is not open.

// In editor with correct file open.
CheckFocusWidget("window1.frame1.editorFrame.m_editorWidget")
CheckFocusWindowTitle("language-test.cc - Editor")

// Activate fake LSP server.
CheckQuery("window1.frame1.editorFrame.m_editorWidget" "lspIsFakeServer" "true")
Shortcut("window1.m_menuBar" "Alt+L")
KeyPress("window1.m_menuBar.lspMenu" "Key_A" "a")

// Open this file in LSP.
Shortcut("window1.m_menuBar.lspMenu.lspOpenOrUpdateFile" "F7")

// Go to line 58.
Shortcut("window1.m_menuBar.editMenu.editGotoLine" "Alt+G")
FocusKeySequence("58")
FocusKeyPR("Key_Return" "\r")

// Back in editor on line 58.
CheckFocusWidget("window1.frame1.editorFrame.m_editorWidget")
CheckQuery("window1.frame1.editorFrame.m_editorWidget" "cursorPosition" "58:1")

// Move into the use of `g_var3` on that line.
FocusKeyPR("Key_Right" "")
FocusKeyPR("Key_Right" "")
FocusKeyPR("Key_Right" "")
FocusKeyPR("Key_Right" "")
CheckQuery("window1.frame1.editorFrame.m_editorWidget" "cursorPosition" "58:5")

// Open the all-uses dialog.
Shortcut("window1.m_menuBar.lspMenu.lspGoToMenu.lspGoToAllUses" "Ctrl+F12")
CheckFocusWidget("diagnostic_details.m_splitter.m_table")

// Check the table contents.  We particularly want to observe that the
// code line in the first row is right, since that file was not open in
// the editor beforehand.
CheckQuery("diagnostic_details" "cell(0 1)" "language-test.h:9")
CheckQuery("diagnostic_details" "cell(0 2)" "extern int g_var3;")
CheckQuery("diagnostic_details" "cell(1 1)" "language-test.cc:58")
CheckQuery("diagnostic_details" "cell(1 2)" "  g_var3 = 3;")

// Go to the first entry.
FocusKeyPR("Key_Return" "\r")

// This should open `language-test.h` in the editor window.
CheckWindowTitle("window1" "language-test.h - Editor")

// And it should be positioned on the declaration of `g_var3`, albeit at
// column 1.
CheckQuery("window1.frame1.editorFrame.m_editorWidget" "cursorPosition" "9:1")

// Focus stays on the table.
CheckFocusWidget("diagnostic_details.m_splitter.m_table")

// Go to the second entry.
FocusKeyPR("Key_Down" "")
FocusKeyPR("Key_Return" "\r")

// This is back in the first file.
CheckWindowTitle("window1" "language-test.cc - Editor")
CheckQuery("window1.frame1.editorFrame.m_editorWidget" "cursorPosition" "58:1")

// Close the dialog.
FocusKeyPR("Key_Escape" "\u{1B}")

// Back in the editor.
CheckFocusWidget("window1.frame1.editorFrame.m_editorWidget")

// EOF
